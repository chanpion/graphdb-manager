# 图数据库管理系统 - 架构设计文档

## 1. 总体架构

### 1.1 系统架构图
```
┌─────────────────────────────────────────────────────────────┐
│                      表现层 (Presentation)                   │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │ 导航组件      │  │ 图表组件      │  │ 查询组件      │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                      业务逻辑层 (Business)                    │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │ 图管理服务    │  │ 查询服务      │  │ 分析服务      │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                      数据访问层 (Data Access)                 │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │ 图引擎        │  │ 存储管理      │  │ 导入导出      │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                      数据存储层 (Storage)                     │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │ LocalStorage │  │ Memory Cache │  │ File System  │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└─────────────────────────────────────────────────────────────┘
```

### 1.2 技术栈选型

#### 前端框架
- **React 18**：UI组件库
- **TypeScript**：类型安全
- **React Router v6**：路由管理

#### 可视化库
- **D3.js v7**：数据可视化核心
- **D3-force**：力导向布局
- **D3-zoom**：缩放平移功能

#### 状态管理
- **React Context API**：全局状态管理
- **React Hooks**：局部状态管理

#### 工具库
- **lodash**：工具函数
- **uuid**：唯一ID生成
- **file-saver**：文件下载

#### UI组件库
- **Ant Design**：基础UI组件（可选）
- **Styled Components**：CSS-in-JS

## 2. 分层架构详解

### 2.1 表现层（Presentation Layer）

**职责**：
- UI组件渲染
- 用户交互处理
- 数据展示

**主要模块**：
- `components/`：React组件
  - `NavigationBar`：顶部导航
  - `ControlPanel`：左侧控制面板
  - `GraphCanvas`：图可视化画布
  - `SidePanel`：右侧属性/查询面板
  - `Modal`：对话框组件

### 2.2 业务逻辑层（Business Logic Layer）

**职责**：
- 业务规则处理
- 数据转换
- 流程控制

**主要模块**：
- `services/`：业务服务
  - `GraphService`：图数据管理服务
  - `QueryService`：查询服务
  - `AnalysisService`：分析服务
  - `LayoutService`：布局服务

### 2.3 数据访问层（Data Access Layer）

**职责**：
- 数据持久化
- 数据验证
- 数据转换

**主要模块**：
- `services/`：数据访问
  - `GraphEngine`：图引擎核心
  - `StorageManager`：存储管理
  - `ImportExport`：导入导出

### 2.4 数据存储层（Storage Layer）

**职责**：
- 数据持久化
- 缓存管理

**存储方案**：
- **LocalStorage**：持久化图数据
- **Memory**：运行时数据缓存
- **File**：文件导入导出

## 3. 核心模块设计

### 3.1 GraphEngine（图引擎）

**职责**：
- 图数据结构的CRUD操作
- 图算法实现
- 图查询处理

**核心方法**：
```typescript
class GraphEngine {
  // 节点操作
  addNode(node: Node): void
  updateNode(nodeId: string, updates: Partial<Node>): void
  deleteNode(nodeId: string): void
  getNode(nodeId: string): Node | undefined
  
  // 边操作
  addEdge(edge: Edge): void
  updateEdge(edgeId: string, updates: Partial<Edge>): void
  deleteEdge(edgeId: string): void
  getEdge(edgeId: string): Edge | undefined
  
  // 查询操作
  findNodeById(id: string): Node | undefined
  findNodesByType(type: string): Node[]
  findPath(start: string, end: string): PathResult
  findNeighbors(nodeId: string, depth?: number): Node[]
  
  // 分析操作
  calculateDegreeCentrality(): Map<string, number>
  findConnectedComponents(): Node[][]
}
```

### 3.2 LayoutService（布局服务）

**职责**：
- 布局算法实现
- 布局切换管理
- 布局参数配置

**布局类型**：
- **Force Layout**：力导向布局
- **Circle Layout**：圆形布局
- **Tree Layout**：树状布局
- **Grid Layout**：网格布局

### 3.3 QueryService（查询服务）

**职责**：
- 查询条件解析
- 查询执行
- 结果返回

**查询类型**：
- 基础查询：ID查询、类型查询
- 路径查询：最短路径、所有路径
- 邻居查询：K度邻居
- 高级查询：模式匹配

### 3.4 StorageManager（存储管理）

**职责**：
- LocalStorage读写
- 数据序列化/反序列化
- 版本管理

**存储结构**：
```typescript
interface StorageData {
  version: string;
  timestamp: number;
  nodes: Node[];
  edges: Edge[];
  settings: GraphSettings;
}
```

## 4. 数据流设计

### 4.1 单向数据流
```
User Action → Component → Service → GraphEngine → State Update → Re-render
```

### 4.2 状态管理

#### 全局状态（Context）
```typescript
interface GlobalState {
  graphData: GraphData;
  selectedNodes: Set<string>;
  selectedEdges: Set<string>;
  queryResults: QueryResult[];
  settings: GraphSettings;
}
```

#### 局部状态（Hooks）
- 组件内部状态
- 表单状态
- UI状态（展开/折叠）

### 4.3 事件处理流程
```
1. 用户触发事件（点击、输入等）
2. 组件事件处理器
3. 调用Service方法
4. Service调用GraphEngine
5. GraphEngine更新数据
6. State更新触发重新渲染
7. D3更新可视化
```

## 5. 目录结构

```
graphdb-manager/
├── public/                    # 静态资源
│   └── index.html
├── src/
│   ├── components/           # React组件
│   │   ├── common/          # 通用组件
│   │   │   ├── Button.tsx
│   │   │   ├── Input.tsx
│   │   │   └── Modal.tsx
│   │   ├── layout/          # 布局组件
│   │   │   ├── NavigationBar.tsx
│   │   │   ├── ControlPanel.tsx
│   │   │   └── SidePanel.tsx
│   │   ├── graph/           # 图相关组件
│   │   │   ├── GraphCanvas.tsx
│   │   │   ├── NodeRenderer.tsx
│   │   │   └── EdgeRenderer.tsx
│   │   ├── query/           # 查询组件
│   │   │   ├── QueryPanel.tsx
│   │   │   └── ResultsPanel.tsx
│   │   └── editor/          # 编辑组件
│   │       ├── PropertyEditor.tsx
│   │       └── StyleEditor.tsx
│   ├── services/            # 业务服务
│   │   ├── GraphEngine.ts   # 图引擎
│   │   ├── GraphService.ts  # 图管理服务
│   │   ├── QueryService.ts  # 查询服务
│   │   ├── LayoutService.ts # 布局服务
│   │   └── StorageService.ts # 存储服务
│   ├── utils/               # 工具函数
│   │   ├── graphUtils.ts
│   │   ├── layoutUtils.ts
│   │   └── exportUtils.ts
│   ├── types/               # 类型定义
│   │   ├── graph.ts
│   │   └── settings.ts
│   ├── hooks/               # 自定义Hooks
│   │   ├── useGraph.ts
│   │   ├── useQuery.ts
│   │   └── useLayout.ts
│   ├── context/             # Context
│   │   └── GraphContext.tsx
│   ├── App.tsx              # 主应用
│   └── index.tsx            # 入口
├── docs/                    # 文档
│   ├── 需求设计.md
│   ├── UI设计.md
│   ├── 架构设计.md
│   ├── 流程设计.md
│   ├── 数据库设计.md
│   └── 技术方案设计.md
├── package.json
└── tsconfig.json
```

## 6. 性能优化策略

### 6.1 渲染优化
- React.memo：组件缓存
- useMemo：计算结果缓存
- useCallback：函数缓存
- 虚拟滚动：大数据量渲染

### 6.2 D3优化
- Canvas渲染（大数据量）
- Web Worker：后台计算
- 增量更新：只更新变化部分
- 节流/防抖：频繁事件处理

### 6.3 数据优化
- 索引结构：快速查询
- 数据压缩：减少存储
- 懒加载：按需加载

## 7. 扩展性设计

### 7.1 插件机制
```typescript
interface Plugin {
  name: string;
  version: string;
  init(graphEngine: GraphEngine): void;
  commands?: Command[];
}
```

### 7.2 自定义布局
```typescript
interface LayoutAlgorithm {
  name: string;
  apply(nodes: Node[], edges: Edge[]): void;
  configure(options: LayoutOptions): void;
}
```

### 7.3 后端对接预留
- API接口层
- 数据适配器
- 认证模块

## 8. 安全设计

### 8.1 数据验证
- 输入验证
- 类型检查
- XSS防护

### 8.2 错误处理
- 全局错误捕获
- 友好错误提示
- 错误日志记录

## 9. 测试策略

### 9.1 单元测试
- Jest：单元测试框架
- React Testing Library：组件测试

### 9.2 集成测试
- Service层测试
- 图算法测试

### 9.3 E2E测试
- Cypress：端到端测试
- 用户流程测试
