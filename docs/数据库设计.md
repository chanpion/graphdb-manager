# 图数据库管理系统 - 数据库设计文档

## 1. 数据库概述

本系统使用**MySQL 8.0**作为元数据存储，用于存储连接配置、图实例信息、Schema缓存、操作日志等数据。MySQL选择的原因：成熟稳定、性能优异、支持事务、ACID特性。

## 2. 数据库连接配置

### 2.1 连接信息

```properties
# application.yml
spring:
  datasource:
    url: jdbc:mysql://localhost:3306/graphdb_manager?useUnicode=true&characterEncoding=utf8&useSSL=false&serverTimezone=Asia/Shanghai
    username: root
    password: ${DB_PASSWORD}
    driver-class-name: com.mysql.cj.jdbc.Driver
    hikari:
      maximum-pool-size: 20
      minimum-idle: 5
      idle-timeout: 600000
      max-lifetime: 1800000
      connection-timeout: 30000

# MyBatis-Plus配置
mybatis-plus:
  # Mapper XML文件位置
  mapper-locations: classpath*:/mapper/**/*.xml
  # 实体类包路径
  type-aliases-package: com.graphmanager.storage.entity
  # 配置
  configuration:
    # 驼峰下划线转换
    map-underscore-to-camel-case: true
    # 日志输出
    log-impl: org.apache.ibatis.logging.slf4j.Slf4jImpl
  global-config:
    # 数据库相关配置
    db-config:
      # 主键类型：自增
      id-type: auto
      # 逻辑删除字段
      logic-delete-field: deleted
      logic-delete-value: 1
      logic-not-delete-value: 0
```

### 2.2 数据库选择

- **MySQL 8.0+**：元数据存储
- **字符集**：utf8mb4（支持emoji和特殊字符）
- **排序规则**：utf8mb4_unicode_ci（不区分大小写）
- **时区**：Asia/Shanghai（北京时间）

## 3. 数据库表设计

### 3.1 连接配置表 (connection_config)

#### 3.1.1 表结构

```sql
CREATE TABLE `connection_config` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '连接ID',
  `name` VARCHAR(100) NOT NULL COMMENT '连接名称',
  `database_type` ENUM('NEO4J', 'NEBULA', 'JANUS') NOT NULL COMMENT '数据库类型',
  `host` VARCHAR(255) NOT NULL COMMENT '主机地址',
  `port` INT UNSIGNED NOT NULL COMMENT '端口号',
  `username` VARCHAR(100) COMMENT '用户名',
  `password_encrypted` TEXT COMMENT '加密后的密码',
  `database_name` VARCHAR(100) COMMENT '数据库名/图空间',
  `storage_type` ENUM('HBASE', 'CASSANDRA') DEFAULT NULL COMMENT '存储类型（仅JANUS）',
  `storage_config` JSON COMMENT '存储配置参数（仅JANUS）',
  `extra_params` JSON COMMENT '额外连接参数',
  `status` TINYINT UNSIGNED DEFAULT 0 COMMENT '连接状态：0-未测试，1-正常，2-异常',
  `description` TEXT COMMENT '连接描述',
  `priority` TINYINT UNSIGNED DEFAULT 5 COMMENT '优先级：1-10',
  `created_by` VARCHAR(100) COMMENT '创建人',
  `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_name` (`name`),
  INDEX `idx_type` (`database_type`),
  INDEX `idx_status` (`status`),
  INDEX `idx_created_at` (`created_at`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='连接配置表';
```

#### 3.1.2 字段说明

| 字段名 | 类型 | 必填 | 默认值 | 说明 |
|-------|------|-------|--------|------|
| id | BIGINT | - | AUTO_INCREMENT | 主键ID |
| name | VARCHAR(100) | 是 | - | 连接名称，系统内唯一 |
| database_type | ENUM | 是 | - | 数据库类型：NEO4J/NEBULA/JANUS |
| host | VARCHAR(255) | 是 | - | 主机地址，IP或域名 |
| port | INT | 是 | - | 端口号 |
| username | VARCHAR(100) | 否 | - | 用户名 |
| password_encrypted | TEXT | 否 | - | 加密后的密码（AES-256） |
| database_name | VARCHAR(100) | 否 | - | Neo4j: Database, Nebula: Space, Janus: Graph |
| storage_type | ENUM | 否 | NULL | 存储类型（仅JanusGraph）：HBASE/CASSANDRA |
| storage_config | JSON | 否 | NULL | 存储配置参数（仅JanusGraph） |
| extra_params | JSON | 否 | NULL | 额外连接参数（JSON格式） |
| status | TINYINT | 否 | 0 | 连接状态：0-未测试，1-正常，2-异常 |
| description | TEXT | 否 | NULL | 连接描述 |
| priority | TINYINT | 否 | 5 | 优先级：1-10，数字越小优先级越高 |
| created_by | VARCHAR(100) | 否 | - | 创建人 |
| created_at | TIMESTAMP | 否 | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | 否 | CURRENT_TIMESTAMP | 更新时间 |

### 3.2 图实例表 (graph_instance)

#### 3.2.1 表结构

```sql
CREATE TABLE `graph_instance` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '图实例ID',
  `connection_id` BIGINT UNSIGNED NOT NULL COMMENT '关联连接ID',
  `graph_name` VARCHAR(100) NOT NULL COMMENT '图名称',
  `database_type` ENUM('NEO4J', 'NEBULA', 'JANUS') NOT NULL COMMENT '数据库类型',
  `vertex_count` BIGINT UNSIGNED DEFAULT 0 COMMENT '节点数量',
  `edge_count` BIGINT UNSIGNED DEFAULT 0 COMMENT '边数量',
  `status` ENUM('NORMAL', 'ARCHIVED') DEFAULT 'NORMAL' COMMENT '图状态',
  `description` TEXT COMMENT '图描述',
  `schema_version` VARCHAR(50) DEFAULT 'v1' COMMENT 'Schema版本号',
  `cache_time` TIMESTAMP NULL COMMENT 'Schema缓存时间',
  `is_default` TINYINT UNSIGNED DEFAULT 0 COMMENT '是否默认图',
  `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  `last_accessed_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '最后访问时间',
  
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_connection_graph` (`connection_id`, `graph_name`),
  INDEX `idx_connection_id` (`connection_id`),
  INDEX `idx_graph_name` (`graph_name`),
  INDEX `idx_status` (`status`),
  INDEX `idx_updated_at` (`updated_at`),
  FOREIGN KEY (`connection_id`) REFERENCES `connection_config`(`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='图实例表';
```

#### 3.2.2 字段说明

| 字段名 | 类型 | 必填 | 默认值 | 说明 |
|-------|------|-------|--------|------|
| id | BIGINT | - | AUTO_INCREMENT | 主键ID |
| connection_id | BIGINT | 是 | - | 关联的连接ID（外键） |
| graph_name | VARCHAR(100) | 是 | - | 图名称 |
| database_type | ENUM | 是 | - | 数据库类型 |
| vertex_count | BIGINT | 否 | 0 | 节点数量（统计信息） |
| edge_count | BIGINT | 否 | 0 | 边数量（统计信息） |
| status | ENUM | 否 | NORMAL | 图状态：NORMAL-正常，ARCHIVED-已归档 |
| description | TEXT | 否 | NULL | 图描述 |
| schema_version | VARCHAR(50) | 否 | v1 | Schema版本号，用于版本控制 |
| cache_time | TIMESTAMP | 否 | NULL | Schema缓存时间，用于判断缓存是否过期 |
| is_default | TINYINT | 否 | 0 | 是否默认图（用户可设置） |
| created_at | TIMESTAMP | 否 | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | 否 | CURRENT_TIMESTAMP | 更新时间 |
| last_accessed_at | TIMESTAMP | 否 | CURRENT_TIMESTAMP | 最后访问时间 |

### 3.3 Schema缓存表 (graph_schema_cache)

#### 3.3.1 表结构

```sql
CREATE TABLE `graph_schema_cache` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '缓存ID',
  `connection_id` BIGINT UNSIGNED NOT NULL COMMENT '关联连接ID',
  `graph_name` VARCHAR(100) NOT NULL COMMENT '图名称',
  `schema_type` ENUM('NODE_TYPE', 'EDGE_TYPE') NOT NULL COMMENT 'Schema类型',
  `type_name` VARCHAR(100) NOT NULL COMMENT '类型名称',
  `schema_data` JSON NOT NULL COMMENT 'Schema定义（JSON格式）',
  `properties_count` INT UNSIGNED DEFAULT 0 COMMENT '属性数量',
  `cache_time` TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '缓存时间',
  `expire_time` TIMESTAMP NOT NULL COMMENT '过期时间',
  
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_connection_graph_type` (`connection_id`, `graph_name`, `schema_type`, `type_name`),
  INDEX `idx_cache_time` (`cache_time`),
  INDEX `idx_expire_time` (`expire_time`),
  INDEX `idx_graph_name` (`graph_name`),
  FOREIGN KEY (`connection_id`) REFERENCES `connection_config`(`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Schema缓存表';
```

#### 3.3.2 字段说明

| 字段名 | 类型 | 必填 | 默认值 | 说明 |
|-------|------|-------|--------|------|
| id | BIGINT | - | AUTO_INCREMENT | 主键ID |
| connection_id | BIGINT | 是 | - | 关联的连接ID |
| graph_name | VARCHAR(100) | 是 | - | 图名称 |
| schema_type | ENUM | 是 | - | Schema类型：NODE_TYPE-节点类型，EDGE_TYPE-边类型 |
| type_name | VARCHAR(100) | 是 | - | 类型名称（节点类型名或边类型名） |
| schema_data | JSON | 是 | - | Schema定义，JSON格式，包含属性定义等 |
| properties_count | INT | 否 | 0 | 属性数量 |
| cache_time | TIMESTAMP | 否 | CURRENT_TIMESTAMP | 缓存时间 |
| expire_time | TIMESTAMP | 是 | - | 过期时间，默认为当前时间+1小时 |

### 3.4 操作日志表 (operation_log)

#### 3.4.1 表结构

```sql
CREATE TABLE `operation_log` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '日志ID',
  `connection_id` BIGINT UNSIGNED NOT NULL COMMENT '关联连接ID',
  `graph_name` VARCHAR(100) COMMENT '图名称',
  `operation_type` ENUM('CONNECT', 'DISCONNECT', 'QUERY', 'CREATE', 'UPDATE', 'DELETE', 'IMPORT', 'EXPORT') NOT NULL COMMENT '操作类型',
  `operation_target` ENUM('CONNECTION', 'GRAPH', 'NODE', 'EDGE', 'SCHEMA', 'IMPORT_EXPORT') NOT NULL COMMENT '操作对象',
  `operation_detail` TEXT COMMENT '操作详情（JSON格式）',
  `result_status` ENUM('SUCCESS', 'FAILURE', 'PARTIAL') NOT NULL COMMENT '结果状态',
  `error_message` TEXT COMMENT '错误信息',
  `execution_time_ms` INT UNSIGNED COMMENT '执行时间（毫秒）',
  `affected_rows` INT UNSIGNED DEFAULT 0 COMMENT '影响行数',
  `user_agent` VARCHAR(255) COMMENT '用户代理',
  `client_ip` VARCHAR(45) COMMENT '客户端IP',
  `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  
  PRIMARY KEY (`id`),
  INDEX `idx_connection_id` (`connection_id`),
  INDEX `idx_graph_name` (`graph_name`),
  INDEX `idx_operation_type` (`operation_type`),
  INDEX `idx_result_status` (`result_status`),
  INDEX `idx_created_at` (`created_at`),
  FOREIGN KEY (`connection_id`) REFERENCES `connection_config`(`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='操作日志表';
```

#### 3.4.2 字段说明

| 字段名 | 类型 | 必填 | 默认值 | 说明 |
|-------|------|-------|--------|------|
| id | BIGINT | - | AUTO_INCREMENT | 主键ID |
| connection_id | BIGINT | 是 | - | 关联的连接ID |
| graph_name | VARCHAR(100) | 否 | NULL | 图名称（有些操作不涉及图） |
| operation_type | ENUM | 是 | - | 操作类型 |
| operation_target | ENUM | 是 | - | 操作对象：CONNECTION-连接，GRAPH-图，NODE-节点，EDGE-边，SCHEMA-Schema，IMPORT_EXPORT-导入导出 |
| operation_detail | TEXT | 否 | NULL | 操作详情，JSON格式，包含具体参数 |
| result_status | ENUM | 是 | - | 结果状态：SUCCESS-成功，FAILURE-失败，PARTIAL-部分成功 |
| error_message | TEXT | 否 | NULL | 错误信息 |
| execution_time_ms | INT | 否 | NULL | 执行时间（毫秒） |
| affected_rows | INT | 否 | 0 | 影响行数（CRUD操作） |
| user_agent | VARCHAR(255) | 否 | NULL | 用户代理（浏览器信息） |
| client_ip | VARCHAR(45) | 否 | NULL | 客户端IP地址 |
| created_at | TIMESTAMP | 否 | CURRENT_TIMESTAMP | 创建时间 |

### 3.5 用户表 (user) - 如果需要认证

#### 3.5.1 表结构

```sql
CREATE TABLE `user` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '用户ID',
  `username` VARCHAR(100) NOT NULL COMMENT '用户名',
  `password_encrypted` TEXT NOT NULL COMMENT '加密后的密码',
  `email` VARCHAR(255) COMMENT '邮箱',
  `full_name` VARCHAR(100) COMMENT '全名',
  `role` ENUM('ADMIN', 'DEVELOPER', 'ANALYST') DEFAULT 'ANALYST' COMMENT '用户角色',
  `status` ENUM('ACTIVE', 'INACTIVE', 'LOCKED') DEFAULT 'ACTIVE' COMMENT '用户状态',
  `last_login_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '最后登录时间',
  `login_count` INT UNSIGNED DEFAULT 0 COMMENT '登录次数',
  `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_username` (`username`),
  INDEX `idx_role` (`role`),
  INDEX `idx_status` (`status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='用户表';
```

#### 3.5.2 字段说明

| 字段名 | 类型 | 必填 | 默认值 | 说明 |
|-------|------|-------|--------|------|
| id | BIGINT | - | AUTO_INCREMENT | 主键ID |
| username | VARCHAR(100) | 是 | - | 用户名，系统内唯一 |
| password_encrypted | TEXT | 是 | - | 加密后的密码（BCrypt） |
| email | VARCHAR(255) | 否 | NULL | 邮箱 |
| full_name | VARCHAR(100) | 否 | NULL | 全名 |
| role | ENUM | 否 | ANALYST | 用户角色：ADMIN-管理员，DEVELOPER-开发人员，ANALYST-数据分析师 |
| status | ENUM | 否 | ACTIVE | 用户状态：ACTIVE-激活，INACTIVE-停用，LOCKED-锁定 |
| last_login_at | TIMESTAMP | 否 | CURRENT_TIMESTAMP | 最后登录时间 |
| login_count | INT | 否 | 0 | 登录次数 |
| created_at | TIMESTAMP | 否 | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | 否 | CURRENT_TIMESTAMP | 更新时间 |

### 3.6 权限表 (permission) - 如果需要权限控制

#### 3.6.1 表结构

```sql
CREATE TABLE `permission` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '权限ID',
  `name` VARCHAR(100) NOT NULL COMMENT '权限名称',
  `code` VARCHAR(100) NOT NULL COMMENT '权限代码',
  `description` TEXT COMMENT '权限描述',
  `resource_type` ENUM('CONNECTION', 'GRAPH', 'SCHEMA', 'DATA', 'IMPORT_EXPORT') NOT NULL COMMENT '资源类型',
  `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_code` (`code`),
  INDEX `idx_resource_type` (`resource_type`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='权限表';
```

#### 3.6.2 权限示例数据

```sql
-- 初始化权限数据
INSERT INTO `permission` (`name`, `code`, `description`, `resource_type`) VALUES
('创建连接', 'CONNECTION_CREATE', '创建图数据库连接', 'CONNECTION'),
('编辑连接', 'CONNECTION_UPDATE', '编辑图数据库连接', 'CONNECTION'),
('删除连接', 'CONNECTION_DELETE', '删除图数据库连接', 'CONNECTION'),
('创建图', 'GRAPH_CREATE', '创建图实例', 'GRAPH'),
('删除图', 'GRAPH_DELETE', '删除图实例', 'GRAPH'),
('查询图', 'GRAPH_QUERY', '查询图实例', 'GRAPH'),
('创建Schema', 'SCHEMA_CREATE', '创建节点类型或边类型', 'SCHEMA'),
('编辑Schema', 'SCHEMA_UPDATE', '编辑节点类型或边类型', 'SCHEMA'),
('删除Schema', 'SCHEMA_DELETE', '删除节点类型或边类型', 'SCHEMA'),
('查询Schema', 'SCHEMA_QUERY', '查询节点类型或边类型', 'SCHEMA'),
('创建节点', 'DATA_NODE_CREATE', '创建节点数据', 'DATA'),
('编辑节点', 'DATA_NODE_UPDATE', '编辑节点数据', 'DATA'),
('删除节点', 'DATA_NODE_DELETE', '删除节点数据', 'DATA'),
('创建边', 'DATA_EDGE_CREATE', '创建边数据', 'DATA'),
('编辑边', 'DATA_EDGE_UPDATE', '编辑边数据', 'DATA'),
('删除边', 'DATA_EDGE_DELETE', '删除边数据', 'DATA'),
('查询数据', 'DATA_QUERY', '查询节点或边数据', 'DATA'),
('导入数据', 'IMPORT_EXPORT_IMPORT', '导入CSV数据', 'IMPORT_EXPORT'),
('导出数据', 'IMPORT_EXPORT_EXPORT', '导出数据', 'IMPORT_EXPORT');
```

### 3.7 用户角色权限关联表 (user_role_permission)

#### 3.7.1 表结构

```sql
CREATE TABLE `user_role_permission` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '关联ID',
  `user_id` BIGINT UNSIGNED NOT NULL COMMENT '用户ID',
  `permission_id` BIGINT UNSIGNED NOT NULL COMMENT '权限ID',
  `granted_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '授权时间',
  
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_user_permission` (`user_id`, `permission_id`),
  INDEX `idx_user_id` (`user_id`),
  INDEX `idx_permission_id` (`permission_id`),
  FOREIGN KEY (`user_id`) REFERENCES `user`(`id`) ON DELETE CASCADE,
  FOREIGN KEY (`permission_id`) REFERENCES `permission`(`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='用户角色权限关联表';
```

## 4. 索引设计

### 4.1 主要索引

**连接配置表索引**：
- PRIMARY KEY: `id`
- UNIQUE KEY: `uk_name` - 保证连接名称唯一
- INDEX: `idx_type` - 按数据库类型查询
- INDEX: `idx_status` - 按连接状态查询
- INDEX: `idx_created_at` - 按创建时间查询

**图实例表索引**：
- PRIMARY KEY: `id`
- UNIQUE KEY: `uk_connection_graph` - 保证同一连接下图名称唯一
- INDEX: `idx_connection_id` - 按连接ID查询
- INDEX: `idx_graph_name` - 按图名称查询
- INDEX: `idx_status` - 按图状态查询
- INDEX: `idx_updated_at` - 按更新时间查询

**Schema缓存表索引**：
- PRIMARY KEY: `id`
- UNIQUE KEY: `uk_connection_graph_type` - 保证Schema唯一性
- INDEX: `idx_cache_time` - 按缓存时间查询
- INDEX: `idx_expire_time` - 按过期时间查询，用于清理过期缓存

**操作日志表索引**：
- PRIMARY KEY: `id`
- INDEX: `idx_connection_id` - 按连接ID查询
- INDEX: `idx_graph_name` - 按图名称查询
- INDEX: `idx_operation_type` - 按操作类型查询
- INDEX: `idx_result_status` - 按结果状态查询
- INDEX: `idx_created_at` - 按创建时间查询，用于日志清理

## 5. 实体类定义

### 5.1 连接配置实体类 (ConnectionEntity)

```java
package com.graphmanager.storage.entity;

import com.baomidou.mybatisplus.annotation.*;
import lombok.Data;
import java.time.LocalDateTime;

/**
 * 连接配置实体类
 */
@Data
@TableName("connection_config")
public class ConnectionEntity {

    /**
     * 主键ID
     */
    @TableId(type = IdType.AUTO)
    private Long id;

    /**
     * 连接名称
     */
    private String name;

    /**
     * 数据库类型：NEO4J/NEBULA/JANUS
     */
    private String databaseType;

    /**
     * 主机地址
     */
    private String host;

    /**
     * 端口号
     */
    private Integer port;

    /**
     * 用户名
     */
    private String username;

    /**
     * 加密后的密码
     */
    private String passwordEncrypted;

    /**
     * 数据库名/图空间
     */
    private String databaseName;

    /**
     * 存储类型（仅JANUS）：HBASE/CASSANDRA
     */
    private String storageType;

    /**
     * 存储配置参数（仅JANUS）
     */
    private String storageConfig;

    /**
     * 额外连接参数（JSON格式）
     */
    private String extraParams;

    /**
     * 连接状态：0-未测试，1-正常，2-异常
     */
    private Integer status;

    /**
     * 连接描述
     */
    private String description;

    /**
     * 优先级：1-10，数字越小优先级越高
     */
    private Integer priority;

    /**
     * 创建人
     */
    private String createdBy;

    /**
     * 创建时间
     */
    @TableField(fill = FieldFill.INSERT)
    private LocalDateTime createdAt;

    /**
     * 更新时间
     */
    @TableField(fill = FieldFill.INSERT_UPDATE)
    private LocalDateTime updatedAt;
}
```

### 5.2 图实例实体类 (GraphInstanceEntity)

```java
package com.graphmanager.storage.entity;

import com.baomidou.mybatisplus.annotation.*;
import lombok.Data;
import java.time.LocalDateTime;

/**
 * 图实例实体类
 */
@Data
@TableName("graph_instance")
public class GraphInstanceEntity {

    /**
     * 主键ID
     */
    @TableId(type = IdType.AUTO)
    private Long id;

    /**
     * 关联连接ID
     */
    private Long connectionId;

    /**
     * 图名称
     */
    private String graphName;

    /**
     * 数据库类型：NEO4J/NEBULA/JANUS
     */
    private String databaseType;

    /**
     * 节点数量
     */
    private Long vertexCount;

    /**
     * 边数量
     */
    private Long edgeCount;

    /**
     * 图状态：NORMAL/ARCHIVED
     */
    private String status;

    /**
     * 图描述
     */
    private String description;

    /**
     * Schema版本号
     */
    private String schemaVersion;

    /**
     * Schema缓存时间
     */
    private LocalDateTime cacheTime;

    /**
     * 是否默认图
     */
    private Integer isDefault;

    /**
     * 创建时间
     */
    @TableField(fill = FieldFill.INSERT)
    private LocalDateTime createdAt;

    /**
     * 更新时间
     */
    @TableField(fill = FieldFill.INSERT_UPDATE)
    private LocalDateTime updatedAt;

    /**
     * 最后访问时间
     */
    @TableField(fill = FieldFill.INSERT_UPDATE)
    private LocalDateTime lastAccessedAt;
}
```

### 5.3 Mapper接口定义

```java
package com.graphmanager.storage.repository;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.graphmanager.storage.entity.ConnectionEntity;
import org.apache.ibatis.annotations.Mapper;
import org.apache.ibatis.annotations.Param;
import java.util.List;

/**
 * 连接配置Mapper接口
 */
@Mapper
public interface ConnectionMapper extends BaseMapper<ConnectionEntity> {

    /**
     * 根据状态查询连接列表
     * @param status 连接状态
     * @return 连接列表
     */
    List<ConnectionEntity> selectByStatus(@Param("status") Integer status);

    /**
     * 根据数据库类型查询连接列表
     * @param databaseType 数据库类型
     * @return 连接列表
     */
    List<ConnectionEntity> selectByDatabaseType(@Param("databaseType") String databaseType);

    /**
     * 根据名称查询连接
     * @param name 连接名称
     * @return 连接实体
     */
    ConnectionEntity selectByName(@Param("name") String name);
}
```

## 6. 数据分区策略

### 5.1 操作日志表分区

由于操作日志表数据量大，采用**按月分区**策略：

```sql
-- 分区表（按月分区，保留最近12个月数据）
CREATE TABLE `operation_log_partitioned` (
  -- 字段定义与operation_log表相同
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
  `connection_id` BIGINT UNSIGNED NOT NULL,
  `graph_name` VARCHAR(100),
  `operation_type` ENUM('CONNECT', 'DISCONNECT', 'QUERY', 'CREATE', 'UPDATE', 'DELETE', 'IMPORT', 'EXPORT') NOT NULL,
  `operation_target` ENUM('CONNECTION', 'GRAPH', 'NODE', 'EDGE', 'SCHEMA', 'IMPORT_EXPORT') NOT NULL,
  `operation_detail` TEXT,
  `result_status` ENUM('SUCCESS', 'FAILURE', 'PARTIAL') NOT NULL,
  `error_message` TEXT,
  `execution_time_ms` INT UNSIGNED,
  `affected_rows` INT UNSIGNED DEFAULT 0,
  `user_agent` VARCHAR(255),
  `client_ip` VARCHAR(45),
  `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  
  PRIMARY KEY (`id`, `created_at`),
  INDEX `idx_connection_id` (`connection_id`),
  INDEX `idx_graph_name` (`graph_name`),
  INDEX `idx_operation_type` (`operation_type`),
  INDEX `idx_result_status` (`result_status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci
PARTITION BY RANGE (YEAR(created_at) * 100 + MONTH(created_at)) (
  PARTITION p202401 VALUES LESS THAN (202401 * 100 + 1),
  PARTITION p202402 VALUES LESS THAN (202402 * 100 + 1),
  PARTITION p202412 VALUES LESS THAN (202412 * 100 + 1),
  PARTITION pmaxvalue VALUES LESS THAN MAXVALUE
);
```

### 5.2 定时清理任务

```sql
-- 清理过期的Schema缓存（超过1小时）
DELETE FROM `graph_schema_cache` 
WHERE `expire_time` < NOW();

-- 清理12个月前的操作日志（定时任务）
-- 可以使用MySQL Event Scheduler实现
CREATE EVENT IF NOT EXISTS `clean_operation_logs`
ON SCHEDULE EVERY 1 MONTH
STARTS CONCAT(CURRENT_DATE, ' 00:00:00')
DO
  DELETE FROM `operation_log_partitioned`
  WHERE `created_at` < DATE_SUB(NOW(), INTERVAL 12 MONTH);
END;
```

## 6. 初始化脚本

### 6.1 数据库初始化SQL

```sql
-- 创建数据库
CREATE DATABASE IF NOT EXISTS `graphdb_manager`
DEFAULT CHARACTER SET utf8mb4
DEFAULT COLLATE utf8mb4_unicode_ci;

-- 使用数据库
USE `graphdb_manager`;

-- 创建管理员账户（默认密码：admin123，需要首次登录后修改）
INSERT INTO `user` (`username`, `password_encrypted`, `full_name`, `role`, `status`)
VALUES (
  'admin',
  '$2a$10$Xxxx...Xxxx',  -- BCrypt加密的admin123
  '系统管理员',
  'ADMIN',
  'ACTIVE'
);

-- 为管理员账户授权所有权限
INSERT INTO `user_role_permission` (`user_id`, `permission_id`)
SELECT u.id, p.id
FROM `user` u
CROSS JOIN `permission` p
WHERE u.username = 'admin';
```

### 6.2 外部依赖数据

如果系统不使用内部认证，可以创建外部用户表，与现有用户系统集成：

```sql
CREATE TABLE `external_user_mapping` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
  `external_user_id` VARCHAR(100) NOT NULL COMMENT '外部系统用户ID',
  `username` VARCHAR(100) NOT NULL COMMENT '系统用户名',
  `external_system` VARCHAR(50) NOT NULL COMMENT '外部系统标识',
  `mapped_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '映射时间',
  
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_external_system_user` (`external_system`, `external_user_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='外部用户映射表';
```

## 7. 数据备份策略

### 7.1 备份方案

- **全量备份**：每天凌晨2点执行全量备份
- **增量备份**：每小时执行增量备份（binlog）
- **备份保留**：保留最近30天的备份文件
- **备份位置**：/data/backup/graphdb_manager/

### 7.2 备份脚本

```bash
#!/bin/bash
# backup.sh

BACKUP_DIR="/data/backup/graphdb_manager"
DATE=$(date +%Y%m%d_%H%M%S)
MYSQL_USER="root"
MYSQL_PASSWORD="${DB_PASSWORD}"
DATABASE="graphdb_manager"

# 创建备份目录
mkdir -p ${BACKUP_DIR}

# 全量备份
mysqldump -u${MYSQL_USER} -p${MYSQL_PASSWORD} \
  --single-transaction \
  --routines \
  --triggers \
  ${DATABASE} | gzip > ${BACKUP_DIR}/full_backup_${DATE}.sql.gz

# 删除30天前的备份
find ${BACKUP_DIR} -name "*.sql.gz" -mtime +30 -delete

echo "Backup completed: ${BACKUP_DIR}/full_backup_${DATE}.sql.gz"
```

## 8. 数据迁移策略

### 8.1 版本控制

使用`schema_version`字段控制Schema版本，支持向后兼容的升级：

```sql
-- 示例：从v1升级到v2
-- 添加新字段
ALTER TABLE `graph_schema_cache` 
ADD COLUMN `version` VARCHAR(20) DEFAULT 'v2' 
AFTER `type_name`;

-- 更新现有数据
UPDATE `graph_schema_cache` 
SET `version` = 'v2' 
WHERE `version` IS NULL;
```

### 8.2 数据迁移

```java
@Component
public class DataMigrationService {
    
    public void migrate(String fromVersion, String toVersion) {
        switch (toVersion) {
            case "v2":
                migrateToV2();
                break;
            case "v3":
                migrateToV3();
                break;
            default:
                log.warn("Unknown target version: {}", toVersion);
        }
    }
    
    private void migrateToV2() {
        // 执行v2版本的数据迁移逻辑
        // 1. 添加新字段
        // 2. 转换现有数据
        // 3. 创建默认数据
    }
}
```

## 9. 数据完整性约束

### 9.1 外键约束

- `graph_instance.connection_id` → `connection_config.id`：删除连接时级联删除图实例
- `graph_schema_cache.connection_id` → `connection_config.id`：删除连接时级联删除Schema缓存
- `operation_log.connection_id` → `connection_config.id`：删除连接时级联删除操作日志
- `user_role_permission.user_id` → `user.id`：删除用户时级联删除权限关联
- `user_role_permission.permission_id` → `permission.id`：删除权限时级联删除关联

### 9.2 唯一性约束

- `connection_config.name`：系统内连接名称唯一
- `graph_instance.connection_id, graph_name`：同一连接下图名称唯一
- `graph_schema_cache.connection_id, graph_name, schema_type, type_name`：同一连接同一图的Schema类型名称唯一
- `user.username`：系统内用户名唯一
- `permission.code`：权限代码唯一
- `user_role_permission.user_id, permission_id`：用户权限关联唯一

### 9.3 检查约束

在应用层实现业务规则检查：

```java
@Service
public class ConnectionService {
    
    @Transactional
    public void createConnection(ConnectionDTO dto) {
        // 检查名称唯一性
        if (connectionRepository.existsByName(dto.getName())) {
            throw new BusinessException("连接名称已存在");
        }
        
        // 测试连接
        if (!adapterService.testConnection(dto)) {
            throw new BusinessException("连接测试失败");
        }
        
        // 保存连接
        // ...
    }
}
```

## 10. 性能优化建议

### 10.1 查询优化

- 使用覆盖索引优化查询
- 避免SELECT *，只查询需要的字段
- 合理使用JOIN，避免N+1问题
- 使用分页查询，避免大结果集

### 10.2 写入优化

- 批量插入替代单条插入
- 使用事务减少锁争用
- 合理设置批量大小（100-1000条）

### 10.3 连接池配置

- 最大连接数：20
- 最小空闲连接数：5
- 连接超时时间：30秒
- 空闲超时时间：10分钟

### 10.4 缓存配置

- Schema缓存：1小时
- 查询结果缓存：5分钟
- 连接配置缓存：10分钟

## 11. 安全建议

### 11.1 密码加密

- 连接密码使用AES-256加密
- 用户密码使用BCrypt加密
- 密钥管理：存储在环境变量或配置中心

### 11.2 SQL注入防护

- 使用参数化查询（PreparedStatement）
- 输入验证和清理
- 最小权限原则（应用账号只读权限）

### 11.3 数据脱敏

- 操作日志中不记录敏感信息
- 响应中脱敏密码字段
- 只在必要时展示完整敏感数据
