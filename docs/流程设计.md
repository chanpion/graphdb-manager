# 图数据库管理系统 - 流程设计文档

## 1. 核心业务流程

### 1.1 系统启动流程
```
开始
  ↓
初始化应用
  ↓
检查LocalStorage
  ↓
  ├─ 有数据 → 加载图数据
  │          ↓
  │      渲染图可视化
  │
  └─ 无数据 → 初始化空图
              ↓
          显示欢迎界面
              ↓
          等待用户操作
```

### 1.2 节点创建流程
```
用户点击"添加节点"
  ↓
打开节点创建对话框
  ↓
用户输入节点信息
  ├─ ID（自动生成或手动输入）
  ├─ 标签
  ├─ 类型
  └─ 自定义属性
  ↓
数据验证
  ├─ 验证失败 → 显示错误提示
  └─ 验证通过 ↓
  ↓
调用GraphService.addNode()
  ↓
GraphEngine.addNode()
  ↓
更新全局状态
  ↓
D3渲染更新
  ↓
显示成功提示
```

### 1.3 边创建流程
```
用户点击"添加边"
  ↓
打开边创建对话框
  ↓
用户选择源节点和目标节点
  ├─ 下拉选择
  └─ 或从图中点击选择
  ↓
用户输入边信息
  ├─ 类型
  ├─ 标签
  └─ 自定义属性
  ↓
数据验证
  ├─ 验证源节点和目标节点存在
  ├─ 验证不自环
  └─ 验证重复边（根据配置）
  ↓
调用GraphService.addEdge()
  ↓
GraphEngine.addEdge()
  ↓
更新全局状态
  ↓
D3渲染更新
  ↓
显示成功提示
```

### 1.4 节点删除流程
```
用户选中节点（单击）
  ↓
点击删除按钮或按Delete键
  ↓
显示确认对话框
  ├─ 取消 → 关闭对话框
  └─ 确认 ↓
  ↓
调用GraphService.deleteNode()
  ↓
GraphEngine.deleteNode()
  ├─ 删除节点
  └─ 删除关联的所有边
  ↓
更新全局状态
  ↓
D3渲染更新（带动画）
  ↓
显示成功提示
```

### 1.5 查询流程

#### 1.5.1 节点ID查询流程
```
用户打开查询面板
  ↓
选择查询类型：节点ID查询
  ↓
输入节点ID
  ↓
点击查询按钮
  ↓
调用QueryService.queryById()
  ↓
GraphEngine.findNodeById()
  ├─ 找到 → 返回节点信息
  └─ 未找到 → 返回空
  ↓
更新查询结果状态
  ↓
显示查询结果
  ├─ 结果不为空 → 高亮显示节点
  └─ 结果为空 → 显示"未找到"
```

#### 1.5.2 路径查询流程
```
用户打开查询面板
  ↓
选择查询类型：路径查询
  ↓
输入起点节点ID和终点节点ID
  ↓
点击查询按钮
  ↓
调用QueryService.queryPath()
  ↓
GraphEngine.findPath()
  ├─ BFS/DFS算法搜索
  ├─ 记录路径
  └─ 返回路径结果
  ↓
更新查询结果状态
  ↓
显示路径信息
  ├─ 路径长度
  ├─ 经过的节点
  └─ 经过边
  ↓
在图中高亮显示路径
```

#### 1.5.3 邻居查询流程
```
用户在图中选中一个节点
  ↓
点击"查询邻居"或使用快捷键
  ↓
输入查询深度（默认为1）
  ↓
调用QueryService.queryNeighbors()
  ↓
GraphEngine.findNeighbors()
  ├─ 遍历邻接表
  ├─ 按深度扩展
  └─ 返回邻居节点集合
  ↓
更新查询结果状态
  ↓
在图中高亮显示
  ├─ 中心节点（不同颜色）
  ├─ 1度邻居
  ├─ 2度邻居（不同颜色）
  └─ ...
```

### 1.6 布局切换流程
```
用户选择新布局
  ↓
调用LayoutService.setLayout()
  ↓
LayoutService计算新坐标
  ├─ 力导向：d3.forceSimulation
  ├─ 圆形：按角度分布
  ├─ 树状：层次布局
  └─ 网格：网格分布
  ↓
应用动画过渡
  ↓
D3更新节点位置
  ↓
图动画展示
  ↓
布局切换完成
```

### 1.7 数据导入流程
```
用户点击"导入"
  ↓
选择文件格式
  ├─ JSON
  ├─ CSV
  └─ 加载示例
  ↓
文件上传
  ↓
ImportService解析文件
  ├─ JSON：JSON.parse
  ├─ CSV：CSV解析
  └─ 验证数据格式
  ↓
数据验证
  ├─ 验证节点ID唯一性
  ├─ 验证边的源/目标节点存在
  └─ 验证数据完整性
  ↓
清空当前图数据（询问用户）
  ↓
调用GraphService.loadGraph()
  ↓
GraphEngine重建图结构
  ├─ 添加节点
  └─ 添加边
  ↓
更新全局状态
  ↓
D3渲染
  ↓
显示导入成功提示
```

### 1.8 数据导出流程
```
用户点击"导出"
  ↓
选择导出格式
  ├─ JSON
  ├─ CSV
  └─ 图片
  ↓
ExportService准备数据
  ├─ JSON：序列化图数据
  ├─ CSV：转换为CSV格式
  └─ 图片：生成SVG/PNG
  ↓
触发文件下载
  ↓
显示导出成功提示
```

## 2. 交互流程

### 2.1 节点选中流程
```
用户点击节点
  ↓
D3捕获点击事件
  ↓
更新selectedNodes状态
  ↓
调用PropertyEditor显示属性
  ↓
高亮选中节点
  ↓
在右侧面板显示详细信息
```

### 2.2 节点拖拽流程
```
用户鼠标按下节点
  ↓
开始拖拽
  ↓
记录初始位置
  ↓
鼠标移动
  ↓
更新节点坐标
  ↓
D3更新节点位置
  ↓
关联边同步更新
  ↓
鼠标释放
  ↓
拖拽结束
  ↓
更新节点坐标到状态
```

### 2.3 画布缩放流程
```
用户滚动鼠标滚轮
  ↓
捕获滚轮事件
  ↓
计算缩放比例
  ↓
更新transform状态
  ├─ scale
  ├─ translateX
  └─ translateY
  ↓
D3应用缩放变换
  ↓
画布缩放
```

### 2.4 右键菜单流程
```
用户右键点击节点/边
  ↓
显示上下文菜单
  ↓
菜单选项
  ├─ 编辑 → 打开编辑对话框
  ├─ 删除 → 执行删除流程
  ├─ 高亮邻居 → 执行邻居查询
  ├─ 查看属性 → 显示属性面板
  └─ 复制ID → 复制到剪贴板
  ↓
用户选择操作
  ↓
执行对应功能
  ↓
关闭菜单
```

## 3. 状态管理流程

### 3.1 全局状态更新流程
```
Component触发Action
  ↓
Dispatch到Context
  ↓
Reducer处理Action
  ↓
计算新状态
  ↓
触发Context更新
  ↓
所有订阅组件re-render
```

### 3.2 局部状态更新流程
```
用户输入
  ↓
触发onChange事件
  ↓
更新useState
  ↓
组件re-render
```

## 4. 错误处理流程

### 4.1 数据验证错误
```
用户输入数据
  ↓
验证函数检查
  ↓
发现错误
  ↓
显示错误提示（Toast）
  ↓
高亮错误字段
  ↓
阻止操作执行
```

### 4.2 查询错误
```
执行查询
  ↓
查询服务异常
  ↓
捕获错误
  ↓
显示错误提示
  ├─ 节点不存在
  ├─ 边不存在
  ├─ 路径不存在
  └─ 系统错误
  ↓
清空查询结果
```

### 4.3 渲染错误
```
React组件渲染异常
  ↓
ErrorBoundary捕获
  ↓
显示错误页面
  ├─ 错误信息
  └─ 刷新按钮
  ↓
记录错误日志
```

## 5. 数据同步流程

### 5.1 节点位置同步
```
D3计算节点位置（力导向）
  ↓
节点位置更新
  ↓
同步到GraphEngine
  ↓
同步到全局状态
  ↓
组件更新
```

### 5.2 图数据持久化流程
```
图数据更新
  ↓
触发自动保存（防抖）
  ↓
StorageService.saveToLocalStorage()
  ↓
序列化数据
  ↓
写入LocalStorage
  ↓
保存完成
```

## 6. 图算法流程

### 6.1 最短路径算法（BFS）
```
输入：起点、终点
  ↓
初始化
  ├─ 队列=[起点]
  ├─ visited={起点}
  └─ parent={起点: null}
  ↓
循环：队列不为空
  ├─ 出队当前节点
  ├─ 如果==终点 → 找到路径，返回
  ├─ 遍历邻居节点
  │   ├─ 未访问 → 标记访问，记录父节点，入队
  │   └─ 已访问 → 跳过
  └─ 继续循环
  ↓
队列为空 → 未找到路径
```

### 6.2 度中心性计算
```
遍历所有节点
  ↓
对每个节点
  ├─ 计算入度
  ├─ 计算出度
  └─ 计算总度数
  ↓
排序
  ↓
返回结果
```

### 6.3 连通分量检测
```
初始化
  ├─ visited = {}
  ├─ components = []
  └─ count = 0
  ↓
遍历所有节点
  ↓
如果节点未访问
  ├─ 新建一个分量
  ├─ DFS/BFS遍历
  ├─ 标记访问
  └─ 添加到分量列表
  ↓
返回连通分量列表
```

## 7. 性能优化流程

### 7.1 大数据渲染优化
```
检测节点数量
  ↓
如果 > 1000
  ↓
切换到Canvas渲染
  ↓
启用虚拟滚动
  ↓
分批渲染
```

### 7.2 布局计算优化
```
开始布局计算
  ↓
检查节点数量
  ↓
如果 > 500
  ↓
启用Web Worker
  ↓
后台计算
  ↓
返回结果
  ↓
应用布局
```

## 8. 用户操作流程图

### 8.1 典型使用流程
```
1. 用户打开系统
   ↓
2. 加载示例数据或导入数据
   ↓
3. 查看图可视化
   ↓
4. 调整布局（力导向/圆形）
   ↓
5. 添加节点和边
   ↓
6. 查询特定节点
   ↓
7. 查询节点间路径
   ↓
8. 分析图结构
   ↓
9. 导出结果
```

## 9. 时序图示例

### 9.1 添加节点时序图
```
用户 → Component: 点击添加节点
Component → Modal: 打开对话框
Modal → Component: 用户输入并确认
Component → GraphService: addNode()
GraphService → GraphEngine: addNode()
GraphEngine → GraphEngine: 验证数据
GraphEngine → GraphEngine: 更新邻接表
GraphEngine → GraphService: 返回成功
GraphService → Context: dispatch(ADD_NODE)
Context → Component: 触发更新
Component → GraphCanvas: 重新渲染
Component → User: 显示成功提示
```

### 9.2 查询路径时序图
```
用户 → QueryPanel: 输入起点和终点
QueryPanel → QueryService: queryPath()
QueryService → GraphEngine: findPath()
GraphEngine → GraphEngine: BFS搜索
GraphEngine → GraphEngine: 构建路径
GraphEngine → QueryService: 返回路径
QueryService → Context: dispatch(QUERY_RESULT)
Context → ResultsPanel: 显示结果
Context → GraphCanvas: 高亮路径
```
